<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SLIDE â€” Heart & Neon Modal</title>
<style>
  :root{
    --bg:#06060a;
    --text:#ffffff;
    --muted:rgba(255,255,255,0.75);
    --neon-cyan: rgba(0,200,255,0.95);
  }
  *{box-sizing:border-box;}
  html,body{height:100%;}
  body {
  background: #0a0a0a;
  color: #fff;
  font-family: "Poppins", sans-serif;
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  overflow-x: hidden;
  overflow-y: auto;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

  main{
    width:100%;
    max-width:980px;
    margin:0 auto;
  }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    border-radius:14px;
    overflow:visible;
    border:1px solid rgba(255,255,255,0.04);
  }

  .hero-wrap{
    position:relative;
    width:100%;
    border-top-left-radius:14px;
    border-top-right-radius:14px;
    overflow:hidden;
    background:#111;
  }

  .hero{
    display:block;
    width:100%;
    height:48vh;
    object-fit:cover;
    cursor:zoom-in;
    -webkit-user-drag:none;
    background:linear-gradient(180deg,#222,#111);
  }

  /* --- NEW: Icon Container Below Image --- */
  .icon-bar{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    padding:12px 20px 0;
  }
  .action-btn{
    width:40px;
    height:40px;
    border-radius:10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background:transparent; /* transparent by default */
    border:0;
    cursor:pointer;
    transition:transform .12s ease, background .12s ease;
    z-index:30;
    margin-left:8px;
  }
  .action-btn:hover{ background:rgba(255,255,255,0.05); }

  /* Default icon (outline) */
  .action-btn svg .icon {
    fill: none;
    stroke: #ffffff;
    stroke-width: 2;
    transition: fill .28s ease, stroke .18s ease, transform .18s ease;
    transform-origin: center;
    
  }

  /* Like button specific styles (active state) */
  #likeBtn.active svg .icon {
    fill: url(#likeGradient);
    stroke: none;
  }
  #likeBtn.active svg { transform: scale(1.06); transition: transform .16s cubic-bezier(.2,.9,.2,1); }

  /* Save button specific styles (active state) */
  #saveBtn.active svg .icon {
    fill: #fff;
    stroke: #fff;
    stroke-width: 0;
  }
  #saveBtn:not(.active) svg .icon {
    stroke-width: 2; /* Bookmark stroke is thicker for better outline */
  }

  .content{
    padding:20px;
  }
  .headline{
    font-size:22px;
    font-weight:800;
    color:var(--text);
    margin:0 0 14px 0;
    line-height:1.15;
  }
  .news-body{
    margin:0 0 40px 0;
    line-height:1.6rem;
    font-size:18px;
    color:var(--muted);
  }
  /* --- NEW: Source capsule is a div, not a link --- */
  .source-capsule{
    display:inline-flex;
    justify-content:center;
    align-items:center;
    padding:12px 22px;
    border-radius:999px;
    background:linear-gradient(90deg,#FF6B3D,#A0522D);
    color:#fff;
    font-weight:700;
    margin-top:18px;
    font-size:15px;
    cursor:pointer; /* make it feel clickable */
    transition: transform .12s ease;
    box-shadow: 0 0 30px #FF6B3D;
  }
  .source-capsule:hover{ transform:translateY(-2px); }


  /* Modal + Neon glow */
  .img-modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:200;
    pointer-events:none;
  }
  .img-modal.open{ display:flex; pointer-events:auto; }

  .img-modal .overlay{
    position:absolute; inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.76));
    backdrop-filter: blur(6px);
  }

  .img-modal .panel{
    position:relative;
    width:100%;
    height:100%;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* neon frame container */
  .img-wrap{
    border-radius:12px;
    overflow:hidden;
    padding:6px; /* tiny border-gap so the glow looks framed */
    background:
      radial-gradient(600px 220px at 50% 30%, rgba(0,120,255,0.06), transparent 30%);
    box-shadow:
      0 10px 10px #3A7BFF,
      0 10px 30px #FF6B3D;
    transition: box-shadow .18s ease;
  }

  /* --- CHANGED: The glowing frame itself (Neon blue with opacity 1 box-shadow) --- */
  .neon-frame{
    display:flex;
    border-radius:8px;
    padding:8px;
    background:linear-gradient(180deg, rgba(8,18,30,0.6), rgba(0,0,0,0.45));
    box-shadow:
      0 0 30px rgba(0,200,255,1), /* Changed opacity to 1 */
      0 0 64px rgba(0,200,255,1), /* Reduced second shadow opacity */
      0 20px 60px rgba(0,0,0,0.45);
    animation: neonPulse 2s infinite alternate ease-in-out;
  }

  @keyframes neonPulse{
    from {
      box-shadow:
        0 0 28px rgba(0,200,255,1),
        0 0 50px rgba(0,160,255,0.6),
        0 20px 60px rgba(0,0,0,0.45);
      transform: translateY(0);
    }
    to {
      box-shadow:
        0 0 56px rgba(0,200,255,1),
        0 0 110px rgba(0,160,255,0.8),
        0 28px 70px rgba(0,0,0,0.5);
      transform: translateY(-2px);
    }
  }

  .neon-frame img.fullimg{
    display:block;
    max-width:100%;
    max-height:80vh;
    width:auto;
    height:auto;
    object-fit:contain;
    border-radius:6px;
    background:#000;
  }

  .img-modal .close-btn{
    position:absolute; right:22px; top:22px; width:44px; height:44px;
    border-radius:10px; border:0; background:rgba(0,0,0,0.5); color:#fff;
    display:inline-flex; align-items:center; justify-content:center; cursor:pointer; z-index:30;
  }

  /* floating pop heart (inserted dynamically) */
  .pop-heart-svg{
    position:fixed;
    left:50%;
    top:40%;
    transform:translate(-50%,-50%) scale(.2);
    width:140px;
    height:140px;
    pointer-events:none;
    z-index:350;
    opacity:0;
    filter: drop-shadow(0 10px 32px rgba(0,0,0,0.6));
  }
  @keyframes popHeart {
    0% { transform:translate(-50%,-50%) scale(.2); opacity:0; }
    10% { transform:translate(-50%,-50%) scale(1.6); opacity:1; }
    55% { transform:translate(-50%,-50%) scale(1.0); opacity:1; }
    100% { transform:translate(-50%,-50%) scale(1.0); opacity:0; }
  }

  /* toast (bookmark) */
  .toast {
    position:fixed; left:50%; bottom:8%; transform:translateX(-50%) translateY(12px);
    background:rgba(0,0,0,0.72); color:#fff; padding:10px 14px; border-radius:12px;
    font-weight:600; font-size:15px; pointer-events:none; opacity:0; z-index:360;
    transition: transform .22s ease, opacity .22s ease;
    box-shadow: 0 12px 30px rgba(0,0,0,0.5);
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  /* small responsive tweak */
  @media (max-width:720px){
    .hero{ height:36vh; }
    .action-btn{ width:40px; height:40px; }
  }
</style>
</head>
<body>
<main>
  <svg width="0" height="0" style="position:absolute" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="likeGradient" x1="0" x2="1" y1="0" y2="1">
        <stop offset="0%" stop-color="#ff2d55"/>
        <stop offset="30%" stop-color="#ff9a3c"/>
        <stop offset="60%" stop-color="#3aa3ff"/>
        <stop offset="100%" stop-color="#d94cff"/>
      </linearGradient>

      <linearGradient id="popGradient" x1="0" x2="1" y1="0" y2="1">
        <stop offset="0%" stop-color="#ff3b6b"/>
        <stop offset="35%" stop-color="#ffb45a"/>
        <stop offset="65%" stop-color="#4cc2ff"/>
        <stop offset="100%" stop-color="#ff6ad1"/>
      </linearGradient>
    </defs>
  </svg>

  <article class="card" id="articleCard" aria-labelledby="headlineText">
    <div class="hero-wrap">
      <button class="img-back" id="imgBack" title="Back" aria-label="Back" style="position:absolute;left:12px;top:12px;z-index:30;background:transparent;border:0;color:#fff;padding:8px;">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path d="M15 18l-6-6 6-6" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <img class="hero" id="heroImage" src="" alt="Article image" />
    </div>

    <div class="icon-bar">
      <button class="action-btn" id="likeBtn" title="Like" aria-pressed="false" aria-label="Like">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" role="img" focusable="false">
          <path class="icon heart" d="M12.1 21s-7.8-4.5-9.4-8.1C0.6 9.7 3.2 6 7.2 6c2.2 0 3.5 1.3 4.8 2.7L12 9.9l0.1-1.2C13.4 7.3 14.8 6 17 6c4 0 6.6 3.7 4.5 6.9-1.6 3.6-9.4 8.1-9.4 8.1z"/>
        </svg>
      </button>
      <button class="action-btn" id="saveBtn" title="Save" aria-pressed="false" aria-label="Save">
        <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true" role="img" focusable="false">
          <path class="icon bookmark" d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
        </svg>
      </button>
    </div>

    <div style="height:1px;background:rgba(255,255,255,0.03); margin-top:12px;"></div>

    <div class="content">
      <h1 class="headline" id="headlineText">Loadingâ€¦</h1>
      <div class="news-body" id="newsBody"></div>
      <div id="sourceCapsule" class="source-capsule" role="button" tabindex="0" aria-label="Go to source article on example.com">
        <span id="siteName">example.com</span>
      </div>
    </div>
  </article>
</main>

<div id="floatingLayer" aria-hidden="true"></div>

<div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>

<div class="img-modal" id="imgModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="overlay" id="modalOverlay" tabindex="-1"></div>
  <div class="panel" role="document">
    <button class="close-btn" id="modalClose" aria-label="Close image">âœ•</button>
    <div class="img-wrap">
      <div class="neon-frame">
        <img class="fullimg" id="modalImage" src="" alt="Full article image" />
      </div>
    </div>
  </div>
</div>

<script>
/* ===== fullnews script (replace existing script block) =====
   - Reads fullnews_data (sessionStorage preferred, fallback localStorage)
   - Renders article
   - Keeps like/save buttons in-sync with stored article flags
   - Forwards like/save/unlike/unsave via your n8n forwarder (N8N_FORWARD_URL)
   - Updates sessionStorage/localStorage article object when toggled
================================================================*/

(function(){
  // Config
  const N8N_FORWARD_URL = "https://n8n-8ush.onrender.com/webhook/request";
  const API_URLS = {
    like: "https://pulse-1-x2sm.onrender.com/like",
    unlike: "https://pulse-1-x2sm.onrender.com/unlike",
    save: "https://pulse-1-x2sm.onrender.com/save",
    unsave: "https://pulse-1-x2sm.onrender.com/unsave"
  };
  const TOAST_EL = document.getElementById('toast');
  const floatingLayer = document.getElementById('floatingLayer');

  // Helpers
  function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
  function showToast(msg, ms = 1800){
    if(!TOAST_EL) return;
    TOAST_EL.style.display = 'block';
    TOAST_EL.textContent = msg;
    requestAnimationFrame(()=> TOAST_EL.classList.add('show'));
    clearTimeout(TOAST_EL._t);
    TOAST_EL._t = setTimeout(()=> {
      TOAST_EL.classList.remove('show');
      setTimeout(()=> { TOAST_EL.style.display = 'none'; }, 200);
    }, ms);
  }
  function extractSiteName(url){ try{ const u=new URL(url); const host=u.hostname; return host.replace(/^www\./,''); }catch(e){ return 'source'; } }

  // Read news object from storage (sessionStorage preferred)
  function readStoredArticle(){
    try {
      const s = sessionStorage.getItem('fullnews_data') || sessionStorage.getItem('newsData') || localStorage.getItem('fullnews_data') || localStorage.getItem('newsData') || null;
      if (!s) return null;
      return JSON.parse(s);
    } catch(e) {
      console.warn('readStoredArticle parse error', e);
      return null;
    }
  }

  // Save article to both session & local (keeps other screens in-sync)
  function persistArticle(obj){
    try {
      const str = JSON.stringify(obj);
      sessionStorage.setItem('fullnews_data', str);
      localStorage.setItem('fullnews_data', str);
    } catch(e){ console.warn('persistArticle failed', e); }
  }

  // Render the article into DOM (keeps markup/layout unchanged)
  let article = readStoredArticle();
  const fallback = {
    image: '',
    headline: 'Loadingâ€¦',
    description: '',
    link: '',
    categories: ''
  };
  if (!article) article = fallback;

  function renderArticle(a){
    try {
      const hero = document.getElementById('heroImage');
      const headlineEl = document.getElementById('headlineText');
      const bodyEl = document.getElementById('newsBody');
      const siteNameEl = document.getElementById('siteName');
      const capsule = document.getElementById('sourceCapsule');

      hero.src = a.image || '';
      hero.alt = a.headline || 'Article image';

      headlineEl.innerText = a.headline || 'Untitled';
      bodyEl.innerHTML = '';
      const raw = a.description || a.news || '';
      if (!raw) {
        bodyEl.innerHTML = '';
      } else {
        // split into readable paragraphs (preserve simple paragraphs)
        const paras = raw.split(/\n\s*\n/).filter(Boolean);
        if (paras.length === 0) {
          // fallback - group sentences into paragraphs
          const sentences = raw.split(/(?<=[.?!])\s+/).filter(Boolean);
          let cur = [];
          for (let i=0;i<sentences.length;i++){
            cur.push(sentences[i]);
            if (cur.length >= 3) { bodyEl.appendChild(createP(cur.join(' '))); cur = []; }
          }
          if (cur.length) bodyEl.appendChild(createP(cur.join(' ')));
        } else {
          paras.forEach(p => bodyEl.appendChild(createP(p)));
        }
      }

      function createP(text){
        const p = document.createElement('p');
        p.innerHTML = escapeHtml(text);
        return p;
      }

      const site = extractSiteName(a.link || '');
      siteNameEl.innerText = site || 'source';
      capsule.setAttribute('aria-label', `Open source: ${site}`);
      capsule.onclick = () => { if (a.link) window.open(a.link, '_blank', 'noopener'); };
      capsule.onkeydown = (e) => { if ((e.key === 'Enter' || e.key === ' ') && a.link) { e.preventDefault(); window.open(a.link, '_blank', 'noopener'); } };

      // set global article reference
      article = a;
    } catch (err) {
      console.warn('renderArticle error', err);
    }
  }

  renderArticle(article);

  // Like/Save button elements
  const likeBtn = document.getElementById('likeBtn');
  const saveBtn = document.getElementById('saveBtn');

  // Sync initial UI state with article flags (support multiple possible flag names)
  function applyInitialButtonStates(a){
    const liked = Boolean(a._liked || a.liked || a.isLiked);
    const saved = Boolean(a._saved || a.bookmark || a.isSaved || a.saved);
    if (liked) { likeBtn.classList.add('active'); likeBtn.setAttribute('aria-pressed', 'true'); } else { likeBtn.classList.remove('active'); likeBtn.setAttribute('aria-pressed','false'); }
    if (saved) { saveBtn.classList.add('active'); saveBtn.setAttribute('aria-pressed','true'); } else { saveBtn.classList.remove('active'); saveBtn.setAttribute('aria-pressed','false'); }
  }
  applyInitialButtonStates(article);

  // Forwarding helper: builds the inner request body and wrapper for n8n forwarder
  function buildForwardPayloadForAction(type, a){
    const email = a.userEmail || a.email || (localStorage.getItem('userEmail') || '');
    const body = {
      email: email,
      headline: a.headline || '',
      news: a.description || a.news || '',
      url: a.link || '',
      image_url: a.image || '',
      categories: Array.isArray(a.categories) ? a.categories : (typeof a.categories === 'string' ? a.categories.split(',').map(s=>s.trim()).filter(Boolean) : [])
    };
    return { method: "POST", link: API_URLS[type], body };
  }

  // Send via n8n forwarder (fetch -> fallback sendBeacon)
  async function forwardAction(type, a){
    if (!API_URLS[type]) { console.warn('Unknown forward type', type); return false; }
    const wrapper = buildForwardPayloadForAction(type, a);
    const body = JSON.stringify(wrapper);
    try {
      const res = await fetch(N8N_FORWARD_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
      if (!res.ok) {
        console.warn('forwardAction: non-ok response', res.status);
        // try to read body for debug
        try { const text = await res.text(); console.warn('response text:', text); } catch(e){}
        return false;
      }
      // try parse json message if present
      try { const j = await res.json(); if (j && (j.message || j.msg)) showToast(j.message || j.msg); } catch(e){}
      return true;
    } catch (err) {
      console.warn('forwardAction fetch failed, trying sendBeacon', err);
    }

    // fallback: sendBeacon best-effort
    try {
      if (navigator && typeof navigator.sendBeacon === 'function') {
        const blob = new Blob([JSON.stringify(wrapper)], { type: 'application/json' });
        const beaconOk = navigator.sendBeacon(N8N_FORWARD_URL, blob);
        if (beaconOk) { console.log('forwardAction: sendBeacon ok for', type); return true; }
        console.warn('forwardAction: sendBeacon returned false');
      } else {
        console.warn('forwardAction: sendBeacon not available');
      }
    } catch(e){
      console.error('forwardAction sendBeacon error', e);
    }
    return false;
  }

  // Toggle handlers
  likeBtn.addEventListener('click', async (ev) => {
    ev.stopPropagation();
    const nowActive = likeBtn.classList.toggle('active');
    likeBtn.setAttribute('aria-pressed', nowActive ? 'true' : 'false');

    // Update article flags/bool
    article._liked = nowActive;
    article.liked = nowActive;
    persistArticle(article); // update storage so liked list pages pick it up

    // Visual pop and forward
    if (nowActive) {
      // animation: floating heart
      const heart = document.createElement('div');
      heart.className = 'pop-heart-svg';
      heart.style.animation = 'popHeart 2000ms cubic-bezier(.2,9,2,1) forwards';
      heart.innerHTML = `<svg viewBox="0 0 24 24" width="140" height="140" aria-hidden="true"><path d="M12.1 21s-7.8-4.5-9.4-8.1C0.6 9.7 3.2 6 7.2 6c2.2 0 3.5 1.3 4.8 2.7L12 9.9l0.1-1.2C13.4 7.3 14.8 6 17 6c4 0 6.6 3.7 4.5 6.9-1.6 3.6-9.4 8.1-9.4 8.1z" fill="url(#popGradient)"/></svg>`;
      floatingLayer.appendChild(heart);
      setTimeout(()=> heart.remove(), 2050);
      showToast('Liked');
      forwardAction('like', article).then(ok => { if (!ok) showToast('Like queued'); });
    } else {
      showToast('Unliked');
      forwardAction('unlike', article).then(ok => { if (!ok) showToast('Unlike queued'); });
    }
  });

  saveBtn.addEventListener('click', async (ev) => {
    ev.stopPropagation();
    const nowActive = saveBtn.classList.toggle('active');
    saveBtn.setAttribute('aria-pressed', nowActive ? 'true' : 'false');

    article._saved = nowActive;
    article.bookmark = nowActive;
    persistArticle(article);

    if (nowActive) {
      showToast('Saved successfully in bookmark ðŸ”–');
      forwardAction('save', article).then(ok => { if (!ok) showToast('Save queued'); });
    } else {
      showToast('Unsaved successfully in bookmark ðŸ”–');
      forwardAction('unsave', article).then(ok => { if (!ok) showToast('Unsave queued'); });
    }
  });

  // Back button logic (preserve your original behaviour)
  document.getElementById('imgBack').addEventListener('click', () => {
    if (document.referrer && !document.referrer.includes('liked.html')) {
      location.href = document.referrer;
    } else if (history.length > 1) {
      history.back();
    } else {
      const emailParam = article?.userEmail ? `?email=${encodeURIComponent(article.userEmail)}` : '';
      location.href = `news.html${emailParam}`;
    }
  });

  // Open/close modal for hero image
  document.getElementById('heroImage').addEventListener('click', function(){ if (this && (this.currentSrc || this.src)) {
    document.getElementById('modalImage').src = this.currentSrc || this.src;
    document.getElementById('imgModal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }});
  document.getElementById('modalClose').addEventListener('click', function(){ document.getElementById('imgModal').classList.remove('open'); document.getElementById('modalImage').src = ''; document.body.style.overflow = ''; });

  // On load: ensure we reflect any flags passed via sessionStorage/localStorage by other screens
  (function init(){
    // If the object from storage uses a different variable name used elsewhere in your app (e.g., fullNewsData),
    // keep a local copy in `article` and also make a duplicate global for older code to read.
    window.fullNewsData = Object.assign({}, article); // keep for backward compatibility
    // Apply UI state
    applyInitialButtonStates(article);
    // Try to send categories buffer if present (this was in your earlier code)
    if (typeof window.__sendCategoriesBufferNow === 'function') {
      try { window.__sendCategoriesBufferNow(); } catch(e) {}
    }
  })();

  // Expose debug send
  window.__forwardActionNow = forwardAction;
  window.__persistFullNews = persistArticle;

  // beforeunload: best-effort beacon send if you want to flush likes/bookmarks (no-op here)
  window.addEventListener('beforeunload', () => {
    // nothing required specifically for like/unlike here because we persist synchronously;
    // but if you had queued items, could attempt navigator.sendBeacon here.
  }, { passive:true });

})();
</script>
</body>
</html>
