<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SLIDE News — Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
<style>
* {box-sizing:border-box; margin:0; padding:0; font-family:"Poppins",sans-serif;}
body {background:#000; color:#fff; height:100vh; display:flex; flex-direction:column; overflow:auto;}

/* HEADER */
header {
  position:fixed; top:0; width:100%; height:80px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 25px;
  background:linear-gradient(90deg,#ff0080,#ff8c00,#40e0d0);
  border-bottom-left-radius:25px; border-bottom-right-radius:25px;
  z-index:12; box-shadow:0 4px 20px rgba(255,0,128,0.5);
}
header .title {font-family: 'Russo One', sans-serif;font-size:30px; font-weight:800; letter-spacing:1px; display:flex; align-items:center;}
header .title #user-email {font-size:16px; font-weight:400; color:#fff; opacity:0.01; margin-left:10px;}
.header-heart-btn {
  width: auto;
  height: auto;
  border-radius: 0;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: none;
  outline: none;
  background: transparent;
}

/* CATEGORY NAV */
#category-bar-container { position:fixed;
top:650px;
left:50px;
width:75%;
display:flex;
justify-content:center;
z-index:11;
}

#category-bar { display:flex;
overflow-x:auto;
scroll-behavior:smooth;
padding:10px 80px;
gap:15px;
border-radius:150px;
}

#category-bar::-webkit-scrollbar { display:flex; }

.category-item {
  flex:0 0 auto; padding:10px 25px; border-radius:50px; background:#111; color:rgba(255,255,255,0.8);
  font-weight:bold; font-size:15px; text-align:center; cursor:pointer;
  transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.4s ease; white-space:nowrap;
}
.category-item.active {
  transform: scale(1.2); opacity:1;
  background: linear-gradient(#FFF32D,#FF2D78); color:#fff;
  box-shadow:0 10px 20px #00bfff,0 10px 40px #2dfeff,10px 0 60px #39ff14,20px 0 80px #ff2bc2;
}

/* CAROUSEL */
.carousel {
  position:relative; flex:1; overflow-y:scroll; scroll-snap-type:y mandatory; scroll-behavior:smooth;
  padding-top:150px; padding-bottom:100px;
}

.news-card {
  scroll-snap-align:center; height:calc(100vh - 250px); display:flex; flex-direction:column; justify-content:flex-start;
  border-radius:25px; margin:30px 20px; color:white; padding:8px; text-align:left;
  transform: scale(0.9); opacity:0.4; transition: transform 0.6s ease, opacity 0.6s ease; cursor:pointer;
  background:#111; border: 1px solid rgba(255,255,255,0.03);
}
.news-card.active { transform: scale(1); opacity:1; }

/* Keep image as-is (not tinted) */
.news-card img { width:100%; border-radius:18px; height:100%; object-fit:cover; margin-bottom:15px; box-shadow:0 8px 20px rgba(0,0,0,0.3); }

/* text/icons remain white/default */
.news-title { font-size:20px; font-weight:700; margin-bottom:10px; color:#fff; }
.news-text { font-size:15px; line-height:1.6; opacity:0.95; margin-bottom:10px; color:#fff; }

/* ICON STYLES */
.news-icons { display:flex; justify-content:flex-end; gap:15px; }
.news-icons span { cursor:pointer; transition: transform 0.18s ease; user-select:none; display:inline-block; line-height:1; width:24px; height:24px; }
.news-icons span:hover { transform: scale(1.1); }
.news-icons span svg .icon { fill:none; stroke:white; stroke-width:2.2; transition: fill .28s ease, stroke .18s ease, transform .18s ease; transform-origin:center; }
.news-icons span.liked svg .icon { fill: url(#feedLikeGradient); stroke:none; }
.news-icons span.liked svg { transform: scale(1.06); transition: transform .16s cubic-bezier(.2,.9,.2,1); }
.news-icons span.saved svg .icon { fill:white; stroke:none; stroke-width:0; }

/* FOOTER */
footer {
  height:70px; display:flex; justify-content:space-around; align-items:center;
  border-top-left-radius:25px; border-top-right-radius:25px;
  background: rgba(20,20,20,0.85); backdrop-filter:blur(10px); box-shadow:0 -4px 30px rgba(255,255,255,0.3);
  z-index:10;
}
footer .nav-icon { width:26px; height:26px; cursor:pointer; transition:all 0.3s ease; }
footer .nav-icon svg { width:100%; height:100%; stroke:white; fill:none; stroke-width:2.2; transition:all 0.3s ease; }
footer .nav-icon.active svg { fill:white; stroke:none; }
footer .nav-icon:hover { transform:scale(1.3); }

/* SHIMMER */
.shimmer-card { scroll-snap-align:center; height:calc(100vh - 250px); display:flex; flex-direction:column; justify-content:flex-start; border-radius:25px; margin:30px 20px; padding:15px; background:#111; transform:scale(0.9); opacity:0.4; transition: transform 0.6s ease, opacity 0.6s ease; }
.shimmer-image, .shimmer-line { position:relative; overflow:hidden; background:#222; border-radius:16px; margin-bottom:15px; }
.shimmer-image { height:50%; border-radius:18px; }
.shimmer-line.full { height:50px; width:90%; }
.shimmer-line.medium { height:50px; width:80%; }
.shimmer-line.short { height:50px; width:60%; }
.shimmer::before { content:""; position:absolute; top:0; left:-150px; height:100%; width:150px; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent); animation:shimmer 1.5s infinite; }
@keyframes shimmer { 100% { transform: translateX(300%); } }

.no-more { text-align:center; padding:30px 20px; color:rgba(255,255,255,0.6); font-size:14px; }

/* TOAST */
.toast {
    position:fixed;
    left:50%;
    bottom:80px;
    transform:translateX(-50%) translateY(12px);
    background:rgba(0,0,0,0.8);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    font-weight:600;
    font-size:15px;
    pointer-events:none;
    opacity:0;
    z-index:360;
    transition:transform .22s ease, opacity .22s ease;
    box-shadow:0 12px 30px rgba(0,0,0,0.5);
    display:flex;
    gap:10px;
    align-items:center;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* FLOAT HEART */
.pop-heart-svg{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.2); width:84px; height:84px; pointer-events:none; z-index:350; opacity:0; text-shadow:0 6px 20px rgba(255,45,85,0.32),0 2px 6px rgba(0,0,0,0.6); animation:none; will-change:transform,opacity; }
@keyframes popHeartAnim { 0%{transform:translate(-50%,-50%) scale(0.2); opacity:0;}10%{transform:translate(-50%,-50%) scale(1.6); opacity:1;}60%{transform:translate(-50%,-50%) scale(1.0); opacity:1;}100%{transform:translate(-50%,-50%) scale(1.0); opacity:0;} }
</style>
</head>

<body>
<header>
  <div class="title">SLIDE <span id="user-email"></span></div>
  <button class="header-heart-btn" id="header-heart" aria-label="Favorites" title="Favorites">
  <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="headerHeartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#f58529"/>
        <stop offset="45%" stop-color="#dd2a7b"/>
        <stop offset="100%" stop-color="#8134af"/>
      </linearGradient>
    </defs>
    <path fill="url(#headerHeartGradient)" stroke="none" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
      C2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3
      C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
  </svg>
</button>
</header>

<div id="category-bar-container">
  <div id="category-bar">
    <div class="category-item active" data-category="For You">for you</div>
    <div class="category-item" data-category="Global">Global</div>
    <div class="category-item" data-category="Business and finance">Business & finance</div>
    <div class="category-item" data-category="Science and technology">Science & technology</div>
    <div class="category-item" data-category="Entertainment">Entertainment</div>
    <div class="category-item" data-category="Sports">Sports</div>
    <div class="category-item" data-category="Lifestyle">Lifestyle</div>
    <div class="category-item" data-category="Trending">Trending</div>
  </div>
</div>

<div class="carousel" id="news-container"></div>

<footer>
  <span class="nav-icon home active" data-target="home">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 10l9-7 9 7v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-10z"/></svg>
  </span>
  <span class="nav-icon search" data-target="search">
    <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
  </span>
  <span class="nav-icon bookmark" data-target="bookmark">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 2h12a1 1 0 0 1 1 1v18l-7-4-7 4V3a1 1 0 0 1 1-1z"/></svg>
  </span>
</footer>

<svg width="0" height="0" style="position:absolute" aria-hidden="true" focusable="false">
  <defs>
    <linearGradient id="feedLikeGradient" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="#ff2d55"/>
      <stop offset="30%" stop-color="#ff9a3c"/>
      <stop offset="60%" stop-color="#3aa3ff"/>
      <stop offset="100%" stop-color="#d94cff"/>
    </linearGradient>
    <linearGradient id="feedPopGradient" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#ff3b6b"/>
      <stop offset="35%" stop-color="#ffb45a"/>
      <stop offset="65%" stop-color="#4cc2ff"/>
      <stop offset="100%" stop-color="#ff6ad1"/>
    </linearGradient>
  </defs>
</svg>

<div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>
<div id="floatingLayer" aria-hidden="true"></div>

<script>
/* ========== INITIAL STATE & CONFIG ========== */
const container = document.getElementById('news-container');
const emailDisplay = document.getElementById('user-email');
const params = new URLSearchParams(window.location.search);
const userEmail = params.get('email') || localStorage.getItem('userEmail') || 'unknown@user.com';
emailDisplay.innerText = userEmail;

const categoryItems = document.querySelectorAll('.category-item');
const categoryBar = document.getElementById('category-bar');

const PAGE_SIZE = 5;
let currentPage = 1;
let selectedCategory = document.querySelector('.category-item.active')?.getAttribute('data-category') || "For You";
let keepFetching = true;
let shownNewsSet = new Set();
let fetchingInProgress = false;

const FEED_CACHE_KEY = 'slide_news_feed_v1';
const FEED_META_KEY = 'slide_news_feed_meta_v1';
const CATEGORIES_BUFFER_KEY = 'categories_buffer'; // buffer used by fullnews.html
const SESSION_FLAG = 'slide_app_session';
const CACHE_TTL_HOURS = 0.5; // 0.5 hours = 30 minutes

const categoryMap = {
  "For You":"For You",
  "Global":"General / Global",
  "Business and finance":"Business & Finance",
  "Science and technology":"Science & Technology",
  "Entertainment":"Entertainment",
  "Sports":"Sports",
  "Lifestyle":"Lifestyle & Society",
  "Trending":"Trending"
};

const newsColors = ["#B92EFF","#FF2D78","#3A7BFF","#A93AFF","#FF6B3D"];
let colorIndex = 0;

/* TOAST */
const toastEl = document.getElementById('toast');
let toastTimer = null;
function showToast(message) {
  toastEl.style.display = 'flex';
  toastEl.innerText = message;
  requestAnimationFrame(()=> toastEl.classList.add('show'));
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> {
    toastEl.classList.remove('show');
    setTimeout(()=> { toastEl.style.display='none'; }, 260);
  }, 2000);
}

/* FLOATING HEART */
function showFloatingHeart() {
  const layer = document.getElementById('floatingLayer');
  const wrapper = document.createElement('div');
  wrapper.className = 'pop-heart-svg';
  wrapper.style.animation = 'none';
  layer.appendChild(wrapper);
  wrapper.innerHTML = `<svg viewBox="0 0 24 24" width="84" height="84" aria-hidden="true"><path class="icon heart" d="M12.1 21s-7.8-4.5-9.4-8.1C0.6 9.7 3.2 6 7.2 6c2.2 0 3.5 1.3 4.8 2.7L12 9.9l0.1-1.2C13.4 7.3 14.8 6 17 6c4 0 6.6 3.7 4.5 6.9-1.6 3.6-9.4 8.1-9.4 8.1z" fill="url(#feedPopGradient)" /></svg>`;
  requestAnimationFrame(()=> { wrapper.style.animation = 'popHeartAnim 2s cubic-bezier(.2,.9,.2,1) forwards'; });
  setTimeout(()=> wrapper.remove(), 2050);
}

/* OBSERVER */
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => { entry.target.classList.toggle('active', entry.isIntersecting); });
}, { threshold: 0.5 });

/* SHIMMER */
function showShimmer(count = 3) {
  const shimmerElems = [];
  for (let i = 0; i < count; i++) {
    const shimmer = document.createElement('div');
    shimmer.className = 'shimmer-card shimmer';
    shimmer.innerHTML = `<div class="shimmer-image shimmer"></div><div class="shimmer-line full shimmer"></div><div class="shimmer-line medium shimmer"></div><div class="shimmer-line short shimmer"></div>`;
    container.appendChild(shimmer);
    shimmerElems.push(shimmer);
  }
  return shimmerElems;
}

/* PERSISTENCE HELPERS */
function cacheKeyForCategory(cat) { return `${FEED_CACHE_KEY}::${cat}`; }
function nowTs() { return Date.now(); }
function hoursToMs(h){ return h * 60 * 60 * 1000; }
function isCacheExpired(savedAt) { if (!savedAt) return true; return (nowTs() - savedAt) > hoursToMs(CACHE_TTL_HOURS); }

function saveFeedToLocal() {
  try {
    const items = [];
    container.querySelectorAll('.news-card').forEach(card => {
      const data = card._newsData || null;
      if (data) items.push(data);
    });
    const meta = { category: selectedCategory, page: currentPage, keepFetching, colorIndex, scrollTop: container.scrollTop, savedAt: nowTs() };
    localStorage.setItem(cacheKeyForCategory(selectedCategory), JSON.stringify({ meta, items }));
    localStorage.setItem(FEED_META_KEY, JSON.stringify({ lastCategory: selectedCategory }));
  } catch (e) { console.warn('saveFeedToLocal failed', e); }
}

function clearCacheForCategory(cat) { try { localStorage.removeItem(cacheKeyForCategory(cat)); } catch(e){} }
function clearAllCaches() {
  try { Object.keys(localStorage).forEach(k=>{ if(k.startsWith(FEED_CACHE_KEY)) localStorage.removeItem(k); }); localStorage.removeItem(FEED_META_KEY); localStorage.removeItem(CATEGORIES_BUFFER_KEY); } catch(e) {}
}

function restoreFeedFromLocal() {
  try {
    const metaRaw = localStorage.getItem(FEED_META_KEY);
    if (metaRaw) {
      const mm = JSON.parse(metaRaw);
      if (mm && mm.lastCategory) selectedCategory = mm.lastCategory;
      categoryItems.forEach(i => i.classList.remove('active'));
      const selectedEl = Array.from(categoryItems).find(it => ((it.getAttribute('data-category') || it.innerText).trim() === selectedCategory));
      if (selectedEl) selectedEl.classList.add('active');
    }
    const raw = localStorage.getItem(cacheKeyForCategory(selectedCategory));
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    if (!parsed || !Array.isArray(parsed.items) || parsed.items.length === 0) return false;
    const savedAt = parsed.meta?.savedAt;
    if (isCacheExpired(savedAt)) { clearCacheForCategory(selectedCategory); return false; }
    const meta = parsed.meta || {};
    currentPage = meta.page || 1;
    keepFetching = typeof meta.keepFetching === 'boolean' ? meta.keepFetching : true;
    colorIndex = typeof meta.colorIndex === 'number' ? meta.colorIndex : 0;
    container.innerHTML = '';
    shownNewsSet.clear();
    parsed.items.forEach(item => {
      const card = createNewsCard(item);
      if (item._liked) card.querySelector('.like')?.classList.add('liked');
      if (item._saved) card.querySelector('.save')?.classList.add('saved');
      container.appendChild(card);
      shownNewsSet.add((item.headline + "||" + (item.description||'')).trim());
    });
    requestAnimationFrame(()=> { container.scrollTop = meta.scrollTop || 0; centerCategory(selectedCategory); });
    return true;
  } catch (e) { console.warn('restoreFeedFromLocal failed', e); return false; }
}

/* SESSION COLD START */
function performColdStartChecks() {
  const keepCacheParam = params.get('keepCache') === '1';
  const sessionFlag = sessionStorage.getItem(SESSION_FLAG);
  if (!sessionFlag && !keepCacheParam) {
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith(FEED_CACHE_KEY)) {
        try {
          const raw = localStorage.getItem(k);
          if (!raw) { localStorage.removeItem(k); return; }
          const parsed = JSON.parse(raw);
          const savedAt = parsed?.meta?.savedAt;
          if (!savedAt || isCacheExpired(savedAt)) { localStorage.removeItem(k); }
        } catch (e) { localStorage.removeItem(k); }
      }
    });
    try { localStorage.removeItem(CATEGORIES_BUFFER_KEY); } catch(e) {}
    const metaRaw = localStorage.getItem(FEED_META_KEY);
    if (metaRaw) {
      try {
        const mm = JSON.parse(metaRaw);
        const catKey = mm?.lastCategory ? cacheKeyForCategory(mm.lastCategory) : null;
        if (!catKey || !localStorage.getItem(catKey)) localStorage.removeItem(FEED_META_KEY);
      } catch (e) { localStorage.removeItem(FEED_META_KEY); }
    }
  }
  sessionStorage.setItem(SESSION_FLAG, String(nowTs()));
}

/* CREATE CARD */
function createNewsCard(news) {
  const card = document.createElement('div');
  card.className = 'news-card';
  const newsCopy = Object.assign({}, news);
  if (!newsCopy.description && newsCopy.news) newsCopy.description = newsCopy.news;
  newsCopy._liked = news._liked || false;
  newsCopy._saved = news._saved || false;
  card._newsData = newsCopy;
  let imgHtml = '';
  if (news.image && news.image.trim()) imgHtml = `<img src="${news.image}" alt="News">`; else imgHtml = `<div style="height:50%; background:#1a1a1a; border-radius:18px; margin-bottom:15px;"></div>`;
  const color = news.backgroundColor || newsColors[colorIndex % newsColors.length];
  colorIndex++;
  card.style.background = color;
  const headlineHtml = `<div class="news-title">${escapeHtml(news.headline)}</div>`;
  const textSnippet = escapeHtml(news.description || '').slice(0, 150) + (news.description && news.description.length > 150 ? '...' : '');
  const descriptionHtml = `<div class="news-text">${textSnippet}</div>`;
  const heartSvg = `<svg viewBox="0 0 24 24" aria-hidden="true" width="24" height="24"><path class="icon heart" d="M12.1 21s-7.8-4.5-9.4-8.1C0.6 9.7 3.2 6 7.2 6c2.2 0 3.5 1.3 4.8 2.7L12 9.9l0.1-1.2C13.4 7.3 14.8 6 17 6c4 0 6.6 3.7 4.5 6.9-1.6 3.6-9.4 8.1-9.4 8.1z"/></svg>`;
  const bookmarkSvg = `<svg viewBox="0 0 24 24" aria-hidden="true" width="24" height="24"><path class="icon bookmark" d="M6 2h12a1 1 0 0 1 1 1v18l-7-4-7 4V3a1 1 0 0 1 1-1z"/></svg>`;
  card.innerHTML = `${imgHtml}${headlineHtml}${descriptionHtml}<div class="news-icons"><span class="like" title="Like">${heartSvg}</span><span class="save" title="Save">${bookmarkSvg}</span></div>`;
  if (newsCopy._liked) card.querySelector('.like')?.classList.add('liked');
  if (newsCopy._saved) card.querySelector('.save')?.classList.add('saved');
  const likeBtn = card.querySelector('.like');
  const saveBtn = card.querySelector('.save');
  likeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const nowLiked = likeBtn.classList.toggle('liked');
    card._newsData._liked = nowLiked;
    saveFeedToLocal();
    if (nowLiked) { showFloatingHeart(); sendAction('like', news); } else { sendAction('unlike', news); }
  });
  saveBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const nowSaved = saveBtn.classList.toggle('saved');
    card._newsData._saved = nowSaved;
    saveFeedToLocal();
    if (nowSaved) { showToast('Saved successfully in bookmark 🔖'); sendAction('save', news); } else { showToast('Unsaved successfully in bookmark 🔖'); sendAction('unsave', news); }
  });

  // click: persist feed + store fullnews_data + add categories to buffer, then navigate
  card.addEventListener('click', () => {
    try {
      const fullData = { ...news, userEmail: userEmail };
      saveFeedToLocal();
      sessionStorage.setItem('fullnews_data', JSON.stringify(fullData));
    } catch (e) { console.warn('sessionStorage set failed', e); }

    // add categories to persistent buffer for fullnews.html to send
    addCategoryToBufferOnly(news.categories);

    // navigate to fullnews
    const newWin = window.open('fullnews.html', '_blank');
    if (!newWin) { window.location.href = 'fullnews.html'; } else { newWin.focus(); }
  });

  observer.observe(card);
  return card;
}

function escapeHtml(str = '') {
  return String(str || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/* FETCH NEWS */
async function fetchNews(infinite = true) {
  if (fetchingInProgress) return;
  fetchingInProgress = true;
  if (!infinite) { container.innerHTML = ""; shownNewsSet.clear(); currentPage = 1; keepFetching = true; }
  if (!keepFetching) { fetchingInProgress = false; return; }
  const shimmerElems = showShimmer(3);
  try {
    const body = { email: userEmail, page: currentPage, pageSize: PAGE_SIZE };
    if (selectedCategory && selectedCategory !== "For You") { const mapped = categoryMap[selectedCategory] || selectedCategory; body.Categories = mapped; }
    const res = await fetch("https://n8n-8ush.onrender.com/webhook/feed", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!res.ok) throw new Error("Network response was not ok");
    const json = await res.json();
    const output = json.output || {};
    shimmerElems.forEach(s => s.remove());
    const items = [];
    for (let i = 1; i <= PAGE_SIZE; i++) {
      const h = output[`headline${i}`]; const n = output[`news${i}`];
      if (!h || !n) continue;
      if (String(h).toLowerCase().includes("headline1")) continue;
      items.push({ headline: h, description: n, image: output[`image${i}`] || "", categories: output[`categories${i}`] || "", link: output[`link${i}`] || "", backgroundColor: newsColors[colorIndex % newsColors.length] });
    }
    if (items.length === 0) {
      keepFetching = false;
      const nm = document.createElement("div"); nm.className = "no-more"; nm.innerText = "No more news in this category."; container.appendChild(nm);
      fetchingInProgress = false; saveFeedToLocal(); return;
    }
    items.forEach(item => {
      const key = (item.headline + "||" + item.description).trim();
      if (shownNewsSet.has(key)) return;
      shownNewsSet.add(key);
      const card = createNewsCard(item);
      container.appendChild(card);
    });
    saveFeedToLocal();
    if (items.length < PAGE_SIZE) { keepFetching = false; const nm = document.createElement("div"); nm.className = "no-more"; nm.innerText = "No more news in this category."; container.appendChild(nm); } else { currentPage++; }
  } catch (err) {
    console.error("❌ Fetch error:", err);
    shimmerElems.forEach(s => s.remove());
    const errEl = document.createElement("div"); errEl.className = "no-more"; errEl.innerText = "Could not load news. Check connection or try again."; container.appendChild(errEl);
    keepFetching = false;
  }
  fetchingInProgress = false;
}

/* ACTIONS FOR LIKE/SAVE (forward via n8n) */
const N8N_FORWARD_URL = "https://n8n-8ush.onrender.com/webhook/request";
async function sendAction(action, news) {
  const urlMap = { like: 'https://pulse-1-x2sm.onrender.com/like', unlike: 'https://pulse-1-x2sm.onrender.com/unlike', save: 'https://pulse-1-x2sm.onrender.com/save', unsave: 'https://pulse-1-x2sm.onrender.com/unsave' };
  const target = urlMap[action];
  if (!target) { console.error('sendAction: unknown action ->', action); return; }
  const requestBody = { email: userEmail || '', headline: news.headline || '', news: news.description || '', url: news.link || '', image_url: news.image || '', categories: Array.isArray(news.categories) ? news.categories : (typeof news.categories === 'string' ? news.categories.split(',').map(s=>s.trim()).filter(Boolean) : []) };
  const forwardPayload = { method: "POST", link: target, body: requestBody };
  try {
    const resp = await fetch(N8N_FORWARD_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(forwardPayload) });
    if (!resp.ok) { let text = ''; try { text = await resp.text(); } catch (_) {} console.error(`Forwarding failed (${resp.status}) for action ${action}. Response:`, text); } else { try { const json = await resp.json(); console.log(`Action "${action}" forwarded to n8n successfully:`, json); } catch (_) { console.log(`Action "${action}" forwarded to n8n (no-json response).`); } }
  } catch (err) { console.error('sendAction: error forwarding to n8n', err); }
}

/* CATEGORIES BUFFER (only store here; fullnews.html will send) */
function normalizeCategoriesField(categories) {
  if (!categories && categories !== 0) return [];
  if (Array.isArray(categories)) return categories.map(x => String(x));
  if (typeof categories === 'string') return categories.split(',').map(s => s.trim()).filter(Boolean);
  return [String(categories)];
}

function addCategoryToBufferOnly(categoriesField) {
  try {
    const normalized = normalizeCategoriesField(categoriesField);
    const raw = localStorage.getItem(CATEGORIES_BUFFER_KEY);
    const buf = raw ? JSON.parse(raw) : [];
    buf.push(normalized);
    localStorage.setItem(CATEGORIES_BUFFER_KEY, JSON.stringify(buf));
    showToast('Category saved locally');
  } catch (e) { console.warn('addCategoryToBufferOnly error', e); }
}

/* UI: center category */
function centerCategory(catName) {
  try {
    const item = Array.from(categoryItems).find(it => ((it.getAttribute('data-category') || it.innerText).trim() === catName));
    if (!item) return;
    const itemLeft = item.offsetLeft;
    const itemCenter = itemLeft + (item.offsetWidth / 2);
    const containerCenter = categoryBar.clientWidth / 2;
    const targetScrollLeft = Math.max(0, itemCenter - containerCenter);
    categoryBar.scrollTo({ left: targetScrollLeft, behavior: 'smooth' });
  } catch (e) { console.warn('centerCategory failed', e); }
}

/* FOOTER NAV + CATEGORY CLICK */
// ===== Replace footer nav click handler with this (append ?email=... on navigation) =====
document.querySelectorAll('footer .nav-icon').forEach(icon => {
  icon.addEventListener('click', () => {
    // update active class UI
    document.querySelectorAll('footer .nav-icon').forEach(i => i.classList.remove('active'));
    icon.classList.add('active');

    const target = icon.getAttribute('data-target');
    const emailParam = userEmail ? `?email=${encodeURIComponent(userEmail)}` : '';

    if (target === 'home') {
      keepFetching = true;
      // restore cached feed if possible, otherwise reload
      if (!restoreFeedFromLocal()) {
        selectedCategory = "For You";
        categoryItems.forEach(i => i.classList.remove('active'));
        const el = Array.from(categoryItems).find(it => (it.getAttribute('data-category') || it.innerText).trim() === selectedCategory);
        if (el) el.classList.add('active');
        fetchNews(false);
      } else {
        centerCategory(selectedCategory);
      }
    } else if (target === 'search') {
      // navigate to search with email param
      keepFetching = false;
      window.location.href = `search.html${emailParam}`;
    } else if (target === 'bookmark') {
      // navigate to bookmark with email param
      keepFetching = false;
      window.location.href = `bookmark.html${emailParam}`;
    }
  });
});


categoryItems.forEach(item => {
  item.addEventListener('click', () => {
    container.innerHTML = "";
    categoryItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    clearCacheForCategory(selectedCategory);
    selectedCategory = item.getAttribute('data-category') || item.innerText;
    currentPage = 1;
    keepFetching = true;
    shownNewsSet.clear();
    colorIndex = 0;
    centerCategory(selectedCategory);
    fetchNews(false);
  });
});

document.getElementById('header-heart').addEventListener('click', () => {
  const btn = document.getElementById('header-heart');
  // keep the existing small click animation
  btn.classList.toggle('active');
  btn.animate(
    [{ transform: 'scale(1)' }, { transform: 'scale(1.08)' }, { transform: 'scale(1)' }],
    { duration: 300, easing: 'ease-out' }
  );

  // Redirect to liked.html with the userEmail as query param
  const emailParam = userEmail ? `?email=${encodeURIComponent(userEmail)}` : '';
  window.location.href = `liked.html${emailParam}`;
});


/* SCROLL: infinite fetch + persist scroll throttle */
container.addEventListener('scroll', () => {
  if (!container._saveScrollThrottle) {
    container._saveScrollThrottle = true;
    setTimeout(()=> { saveFeedToLocal(); container._saveScrollThrottle = false; }, 800);
  }
  if (container.scrollTop + container.clientHeight >= container.scrollHeight - 300) {
    if (keepFetching && !fetchingInProgress) fetchNews(true);
  }
});

/* AUTO REFRESH WHILE OPEN: check every 1 minute and clear if cache older than TTL */
setInterval(() => {
  const metaRaw = localStorage.getItem(FEED_META_KEY);
  if (!metaRaw) return;
  try {
    const mm = JSON.parse(metaRaw);
    const catKey = mm?.lastCategory ? cacheKeyForCategory(mm.lastCategory) : null;
    if (!catKey) return;
    const raw = localStorage.getItem(catKey);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    const savedAt = parsed?.meta?.savedAt;
    if (!savedAt) return;
    if (isCacheExpired(savedAt)) {
      console.log('Auto-clear during session: cache expired -> clearing and refetching');
      clearAllCaches();
      // reset to For You and fetch fresh
      selectedCategory = "For You";
      categoryItems.forEach(i => i.classList.remove('active'));
      const el = Array.from(categoryItems).find(it => (it.getAttribute('data-category') || it.innerText).trim() === selectedCategory);
      if (el) el.classList.add('active');
      fetchNews(false);
    }
  } catch (e) { console.warn('auto-refresh check failed', e); }
}, 60 * 1000); // every minute

/* INITIAL LOAD */
performColdStartChecks();
if (!restoreFeedFromLocal()) {
  selectedCategory = "For You";
  categoryItems.forEach(i => i.classList.remove('active'));
  const el = Array.from(categoryItems).find(it => (it.getAttribute('data-category') || it.innerText).trim() === selectedCategory);
  if (el) el.classList.add('active');
  requestAnimationFrame(()=> centerCategory(selectedCategory));
  fetchNews(false);
} else {
  requestAnimationFrame(()=> centerCategory(selectedCategory));
}
</script>
</body>
</html>
