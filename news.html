<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SLIDE News</title>

<style>
* {box-sizing:border-box; margin:0; padding:0; font-family:"Poppins",sans-serif;}

body {
  background:#000;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER */
header {
  position:fixed;
  top:0;
  width:100%;
  height:80px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 25px;
  background:linear-gradient(90deg,#ff0080,#ff8c00,#40e0d0);
  border-bottom-left-radius:25px;
  border-bottom-right-radius:25px;
  z-index:10;
  box-shadow:0 4px 20px rgba(255,0,128,0.5);
}

header .title {
  font-size:30px;
  font-weight:800;
  letter-spacing:1px;
  display:flex;
  align-items:center;
}

header .title #user-email {
  font-size:16px;
  font-weight:400;
  color:#fff;
  opacity:0.8;
  margin-left:10px;
}

header .heart {
  font-size:28px;
  background:linear-gradient(45deg,#ff3366,#ff6699,#ffcc33);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

/* CAROUSEL */
.carousel {
  position: relative;
  flex:1;
  overflow-y: scroll;
  scroll-snap-type: y mandatory;
  scroll-behavior: smooth;
  padding-top:100px;
  padding-bottom:100px;
}

.news-card {
  scroll-snap-align: center;
  height: calc(100vh - 250px);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  border-radius: 25px;
  margin: 30px 20px;
  color: white;
  padding: 15px;
  text-align: left;
  transform: scale(0.9);
  opacity: 0.4;
  transition: transform 0.6s ease, opacity 0.6s ease;
}

.news-card.active {transform: scale(1); opacity:1;}

.news-card img {
  width:100%;
  border-radius:18px;
  height:50%;
  object-fit:cover;
  margin-bottom:15px;
  box-shadow:0 8px 20px rgba(0,0,0,0.3);
}

.news-title {font-size:20px; font-weight:700; margin-bottom:10px;}
.news-text {font-size:15px; line-height:1.6; opacity:0.95; margin-bottom:10px;}

/* ICONS OUTLINED STYLE */
.news-icons {display:flex; justify-content:flex-end; gap:15px;}
.news-icons span {
  cursor:pointer;
  font-size:22px;
  color:transparent;
  -webkit-text-stroke:1px white;
  transition: transform 0.3s ease, color 0.3s ease, -webkit-text-stroke 0.3s ease;
}
.news-icons span:hover {transform: scale(1.2);}
.news-icons span.liked, .news-icons span.saved {
  color:white;
  -webkit-text-stroke:0;
}

/* FOOTER */
footer {
  height:70px;
  display:flex;
  justify-content:space-around;
  align-items:center;
  border-top-left-radius:25px;
  border-top-right-radius:25px;
  background: rgba(20,20,20,0.85);
  backdrop-filter:blur(10px);
  box-shadow:0 -4px 30px rgba(255,255,255,0.3);
  z-index:10;
}

footer i {
  font-size:26px;
  color:transparent;
  -webkit-text-stroke:1px white;
  cursor:pointer;
  transition:all 0.3s ease;
}
footer i.active {
  -webkit-text-stroke:0;
  color:white;
}
footer i:hover {transform:scale(1.3);}

/* SHIMMER */
.shimmer-card {
  scroll-snap-align: center;
  height: calc(100vh - 250px);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  border-radius: 25px;
  margin: 30px 20px;
  padding: 15px;
  background:#111;
  transform: scale(0.9);
  opacity: 0.4;
  transition: transform 0.6s ease, opacity 0.6s ease;
}

.shimmer-image, .shimmer-line {
  position: relative;
  overflow: hidden;
  background:#222;
  border-radius:16px;
  margin-bottom:15px;
}
.shimmer-image {height:50%; border-radius:18px;}
.shimmer-line.full {height:50px; width:90%;}
.shimmer-line.medium {height:50px; width:80%;}
.shimmer-line.short {height:50px; width:60%;}

.shimmer::before {
  content:"";
  position:absolute;
  top:0;
  left:-150px;
  height:100%;
  width:150px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  animation:shimmer 1.5s infinite;
}
@keyframes shimmer {100% {transform: translateX(300%);}}
</style>
</head>

<body>
<header>
  <div class="title">
    SLIDE
    <span id="user-email"></span>
  </div>
  <div class="heart">‚ù§Ô∏è</div>
</header>

<div class="carousel" id="news-container"></div>

<footer>
  <i class="home active">üè†</i>
  <i class="search">üîé</i>
  <i class="bookmark">üîñ</i>
</footer>

<script>
const container = document.getElementById('news-container');
const emailDisplay = document.getElementById('user-email');
const params = new URLSearchParams(window.location.search);
const userEmail = params.get('email') || localStorage.getItem('userEmail') || 'unknown@user.com';
emailDisplay.innerText = userEmail;

let keepFetching = true;
const shownNewsSet = new Set(); // store headline+description pairs

const colors = [
  {bg:"#FF2D78", text:"#fff"}, // Hot Pink
  {bg:"#3A7BFF", text:"#fff"}, // Electric Blue
  {bg:"#A93AFF", text:"#fff"}, // Purple Magenta
  {bg:"#FF6B3D", text:"#fff"}, // Sunset Orange
  {bg:"#FFF23D", text:"#000"}  // Neon Yellow
];

// Show shimmer
function showShimmer() {
  for(let i=0;i<5;i++){
    const shimmer=document.createElement('div');
    shimmer.className='shimmer-card shimmer';
    shimmer.innerHTML=`
      <div class="shimmer-image shimmer"></div>
      <div class="shimmer-line full shimmer"></div>
      <div class="shimmer-line medium shimmer"></div>
      <div class="shimmer-line short shimmer"></div>
    `;
    container.appendChild(shimmer);
  }
}

// Fetch loop
async function fetchNews(){
  while(keepFetching){
    try{
      showShimmer();

      const res = await fetch(`https://n8n-8ush.onrender.com/webhook/feed?ts=${Date.now()}`, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Cache-Control':'no-cache',
          'Pragma':'no-cache'
        },
        body: JSON.stringify({ email: userEmail })
      });

      if(!res.ok) throw new Error("Fetch failed");

      const { output } = await res.json();
      document.querySelectorAll('.shimmer-card.shimmer').forEach(s=>s.remove());

      const newBatch = [];
      for(let i=1;i<=5;i++){
        const headline = output[`headline${i}`];
        const desc = output[`news${i}`];
        if(!headline || !desc) continue;
        const uniqueKey = headline.trim() + desc.trim();
        if(shownNewsSet.has(uniqueKey)) continue;
        shownNewsSet.add(uniqueKey);
        newBatch.push({
          headline,
          description: desc,
          image: output[`image${i}`] || "",
          categories: output[`categories${i}`] || "",
          link: output[`link${i}`] || ""
        });
      }

      if(newBatch.length === 0){
        console.log("‚ö†Ô∏è No new news found, waiting...");
        await new Promise(r=>setTimeout(r,8000));
        continue;
      }

      newBatch.forEach((news, idx)=>{
        const color = colors[(container.childElementCount + idx) % colors.length];
        const card=document.createElement('div');
        card.className='news-card';
        card.style.background=color.bg;
        card.style.color=color.text;
        card.innerHTML=`
          <img src="${news.image}" alt="News">
          <div class="news-title">${news.headline}</div>
          <div class="news-text">${news.description.slice(0,120)}...</div>
          <div class="news-icons">
            <span class="like">‚ù§Ô∏è</span>
            <span class="save">üîñ</span>
          </div>
        `;
        const likeBtn=card.querySelector('.like');
        const saveBtn=card.querySelector('.save');
        likeBtn.addEventListener('click',()=>{likeBtn.classList.toggle('liked');sendAction('like',news);});
        saveBtn.addEventListener('click',()=>{saveBtn.classList.toggle('saved');sendAction('save',news);});
        container.appendChild(card);
      });

      // Scale animation
      const cards=document.querySelectorAll('.news-card');
      const observer=new IntersectionObserver(entries=>{
        entries.forEach(entry=>{
          entry.target.classList.toggle('active',entry.isIntersecting);
        });
      },{threshold:0.5});
      cards.forEach(c=>observer.observe(c));

    }catch(err){
      console.error("‚ùå Fetch error:",err);
    }
    await new Promise(r=>setTimeout(r,8000));
  }
}

// Like/Save
async function sendAction(action,news){
  const urlMap={
    like:'https://pulse-1-x2sm.onrender.com/like',
    save:'https://pulse-1-x2sm.onrender.com/save'
  };
  try{
    await fetch(urlMap[action],{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        email:userEmail,
        headline:news.headline,
        news:news.description,
        url:news.link,
        image_url:news.image,
        categories:news.categories
      })
    });
  }catch(err){console.error("Action failed:",err);}
}

// Footer navigation
document.querySelectorAll('footer i').forEach(icon=>{
  icon.addEventListener('click',()=>{
    document.querySelectorAll('footer i').forEach(i=>i.classList.remove('active'));
    icon.classList.add('active');

    if(icon.classList.contains('home')){
      keepFetching=true;
      fetchNews();
    } else if(icon.classList.contains('search')){
      keepFetching=false;
      window.location.href='search.html';
    } else if(icon.classList.contains('bookmark')){
      keepFetching=false;
      window.location.href='bookmark.html';
    }
  });
});

// Initial start
fetchNews();
</script>
</body>
</html>
