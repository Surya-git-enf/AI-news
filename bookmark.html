<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bookmark â€” SLIDE News</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#050505;
    --card:#0f0f0f;
    --muted:rgba(255,255,255,0.72);
    --white:#ffffff;
    --gap:12px;
  }
  *{box-sizing:border-box;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--white); font-family:"Poppins",sans-serif;}
  header{
    height:64px; display:flex; align-items:center; gap:12px; padding:0 12px;
    border-bottom:1px solid rgba(255,255,255,0.08);
    position:sticky; top:0; background:var(--bg); z-index:20;
  }
  .back-btn{
    width:44px; height:44px; display:flex; align-items:center; justify-content:center;
    background:transparent; border:0; color:var(--white); cursor:pointer;
  }
  header h1{ font-family:"Pacifico",cursive; color:var(--white); font-size:20px; margin:0; text-align:center; flex:1; pointer-events:none; }

  /* MAIN LIST (vertical scroll) */
  .list {
    height: calc(100% - 64px); /* full height below header */
    padding: 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    -webkit-overflow-scrolling: touch;
  }

  /* Card = horizontal layout (image left, text right) */
  .card{
    display: flex;
    flex-direction: row;
    gap: 12px;
    background: var(--card);
    border-radius:12px;
    overflow: hidden;
    border:1px solid rgba(255,255,255,0.04);
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease;
    align-items: flex-start;
    padding: 5px;
    scroll-snap-align: start;
    color: var(--white);
    text-shadow: 0 1px 2px rgba(0,0,0,0.6); /* helps white text on light gradients */
  }
  .card:focus, .card:hover{ transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.5); outline: none; }

  .card-media {
    flex: 0 0 140px; /* fixed media width */
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    background:#111;
  }
  .card-media img{
    width: 140px;
    height: 140px;
    object-fit: cover;
    display: block;
    border-radius: 8px;
  }

  .card-body{
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0; /* allow text truncation */
  }

  .headline{ font-weight:700; font-size:16px; margin:0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--white); }
  .desc{ font-weight:400; font-size:14px; color:var(--white); line-height:1.4; overflow:hidden; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; }

  .meta-row { display:flex; gap:8px; align-items:center; margin-top:auto; color:rgba(255,255,255,0.85); font-size:12px; }

  .empty{ text-align:center; color:var(--muted); margin:70px 20px; font-size:16px; }

  /* Light pastel gradients for uniqueness (cycle these) */
 .gradient-0 { background: linear-gradient(135deg, #0f2027 0%, #203a43 100%); }
.gradient-1 { background: linear-gradient(135deg, #232526 0%, #414345 100%); }
.gradient-2 { background: linear-gradient(135deg, #141e30 0%, #243b55 100%); }
.gradient-3 { background: linear-gradient(135deg, #1e130c 0%, #9a8478 100%); }
.gradient-4 { background: linear-gradient(135deg, #3a1c71 0%, #d76d77 100%); }
.gradient-5 { background: linear-gradient(135deg, #000000 0%, #434343 100%); }
.gradient-6 { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); }
.gradient-7 { background: linear-gradient(135deg, #232526 0%, #3a3a3a 100%); }
.gradient-8 { background: linear-gradient(135deg, #1f1c2c 0%, #928dab 100%); }
.gradient-9 { background: linear-gradient(135deg, #373b44 0%, #4286f4 100%); }
  /* subtle border for light cards */
  .gradient-0, .gradient-1, .gradient-2, .gradient-3 {
    border: 1px solid rgba(0,0,0,0.06);
    /* keep white text legible by adding a thin dark overlay via text-shadow above */
  }

  /* SHIMMER LOADING */
  .shimmer {
    position: relative;
    overflow: hidden;
    background: #151515;
  }
  .shimmer::after {
    content: "";
    position: absolute;
    top: 0; left: -150px;
    height: 100%; width: 150px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer {
    100% { left: 100%; }
  }

  .skeleton-card {
    display: flex;
    flex-direction: row;
    gap: 12px;
    background: var(--card);
    border-radius:12px;
    padding:12px;
  }
  .skeleton-img { width:140px; height:140px; border-radius:8px; }
  .skeleton-text { flex:1; display:flex; flex-direction:column; gap:10px; }
  .skeleton-line { height:16px; border-radius:4px; width:100%; }
  .skeleton-line.short { width:60%; }

  /* scrollbar styles */
  .list::-webkit-scrollbar{ width:10px; }
  .list::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.04); border-radius:8px; }

  @media (max-width:420px){
    .card-media img{ width:110px; height:110px; }
    .card-media{ flex:0 0 110px; }
    .headline{ font-size:15px; }
  }
  @media (max-width:380px){
    .card{ flex-direction: column; align-items:stretch; }
    .card-media{ flex:0 0 auto; width:100%; height:auto; }
    .card-media img{ width:100%; height:160px; object-fit:cover; }
  }
</style>
</head>
<body>
  <header>
    <button class="back-btn" id="backBtn" title="Back" aria-label="Back">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    <h1>bookmark</h1>
    <div style="width:44px;"></div>
  </header>

  <div id="list" class="list" role="list" aria-live="polite"></div>
  <div id="empty" class="empty" style="display:none;">No news loved yet? The favorites list is feeling lonely!</div>

<script>
/* fallback article */
const FALLBACK = {
  image: "https://static.toiimg.com/thumb/msid-124411047,width-1070,height-580,imgsize-831703,resizemode-75,overlay-toi_sw,pt-32,y_pad-40/photo.jpg",
  headline: "Neuroscientist Unveils Simple Techniques to Enhance Workplace Focus and Calm",
  description: `In an increasingly demanding professional landscape, many individuals grapple with burnout and a lack of focus. NYU neuroscientist Dr. Wendy Suzuki offers two straightforward, science-backed methods to cultivate greater concentration, motivation, and tranquility at work.\n\nHer approach centers on simple micro-habits: brief aerobic movement, breathwork, and short mindful pauses throughout the day that reshape neural circuits and reduce stress.\n\nAdopting these small practices consistently can improve attention, mood, and long-term resilience.`,
  link: "https://timesofindia.indiatimes.com/",
  categories: "Science, Health",
  bookmark: true
};

function escapeHtml(s=''){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
function getEmail(){
  const q = new URLSearchParams(location.search).get('email');
  if (q) return q;
  const ls = localStorage.getItem('userEmail');
  if (ls) return ls;
  return null;
}
const USER_EMAIL = getEmail();

/* back button */
document.getElementById('backBtn').addEventListener('click', () => {
  if (document.referrer && !document.referrer.includes('bookmark.html')) {
    location.href = document.referrer;
  } else if (history.length > 1) {
    history.back();
  } else {
    location.href = `news.html${USER_EMAIL ? '?email='+encodeURIComponent(USER_EMAIL):''}`;
  }
});

/* shimmer loader (single correct definition) */
function showShimmer(count=5){
  const list=document.getElementById('list');
  list.innerHTML='';
  for(let i=0;i<count;i++){
    const s=document.createElement('div');
    s.className='skeleton-card';
    s.innerHTML=`
      <div class="skeleton-img shimmer"></div>
      <div class="skeleton-text">
        <div class="skeleton-line shimmer"></div>
        <div class="skeleton-line shimmer"></div>
        <div class="skeleton-line shimmer short"></div>
      </div>`;
    list.appendChild(s);
  }
}
function hideShimmer(){
  const list=document.getElementById('list');
  list.querySelectorAll('.skeleton-card').forEach(el=>el.remove());
}

/* fetch via n8n wrapper; if fails use fallback */
async function fetchbookmark(email){
  if (!email) throw new Error('No email available');
  const wrapper = { link: "https://pulse-1-sq0g.onrender.com/getsaved", method: "GET", body: { email: email } };
  try {
    const r = await fetch("https://n8n-8ush.onrender.com/webhook/request", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(wrapper)
    });
    if (!r.ok) {
      const t = await r.text().catch(()=>'(no body)');
      throw new Error(`status ${r.status}: ${t}`);
    }
    const text = await r.text();
    try {
      const parsed = JSON.parse(text);
      if (Array.isArray(parsed)) return parsed.map(it => { try { return typeof it === 'string' ? JSON.parse(it) : it; } catch(e){ return it; } });
      return parsed;
    } catch(e){
      try { return JSON.parse(text.replace(/\\"/g,'"')); } catch(e2){ console.warn('bookmark parse fail', e2); return []; }
    }
  } catch (err) {
    console.warn('fetchbookmark failed, using fallback', err);
    return [FALLBACK];
  }
}

/* create horizontal card markup with gradient cycling */
function createCard(item, index=0){
  const headline = item.headline || item.title || '';
  const desc = item.news || item.description || item.summary || '';
  const img = item.image_url || item.image || item.img || '';
  const link = item.url || item.link || item.urlToImage || '';
  const categories = item.categories || item.Categories || item.category || [];

  const card = document.createElement('div');
  // cycle gradients 0..3
  const gradIndex = index % 4;
  card.className = `card gradient-${gradIndex}`;
  card.setAttribute('role','listitem');
  card.setAttribute('tabindex','0');
  card.innerHTML = `
    <div class="card-media" aria-hidden="true">
      <img src="${escapeHtml(img || 'https://via.placeholder.com/800x400?text=No+Image')}" alt="${escapeHtml(headline)}">
    </div>
    <div class="card-body">
      <div class="headline" title="${escapeHtml(headline)}">${escapeHtml(headline.length > 200 ? headline.slice(0,200) + '...' : headline)}</div>
      <div class="desc">${escapeHtml(desc.length > 800 ? desc.slice(0,800) + '...' : desc)}</div>
      <div class="meta-row">
        <span>${Array.isArray(categories) ? categories.join(', ') : (typeof categories === 'string' ? categories : '')}</span>
      </div>
    </div>
  `;

  card.addEventListener('click', () => {
    const payload = {
      userEmail: USER_EMAIL,
      headline: headline,
      description: desc,
      image: img,
      link: link,
      categories: Array.isArray(categories) ? categories : (typeof categories === 'string' ? categories.split(',').map(s=>s.trim()).filter(Boolean) : []),
      bookmark: true
    };
    try { sessionStorage.setItem('fullnews_data', JSON.stringify(payload)); } catch(e){ console.warn('sessionStorage failed', e); }
    const q = USER_EMAIL ? `?email=${encodeURIComponent(USER_EMAIL)}` : '';
    location.href = 'fullnews.html' + q;
  });

  card.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
  });

  return card;
}

/* init */
(async function init(){
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');

  // show shimmer immediately while we fetch
  showShimmer(5);

  // If no user email, show a single fallback card (but still hide shimmer)
  if (!USER_EMAIL) {
    hideShimmer();
    list.innerHTML = ''; // ensure skeletons cleared
    list.appendChild(createCard(FALLBACK, 0));
    return;
  }

  try {
    const res = await fetchbookmark(USER_EMAIL);
    // normalize items and convert headline1/news1 style
    let items = [];
    if (Array.isArray(res)) items = res;
    else if (typeof res === 'object' && res !== null) {
      if (Array.isArray(res.items)) items = res.items;
      else if (Array.isArray(res.output)) items = res.output;
      else {
        for (let i=1;i<40;i++){
          const h = res[`headline${i}`]; const n = res[`news${i}`];
          if (!h && !n) break;
          items.push({ headline: h, news: n, image_url: res[`image${i}`] || '', url: res[`link${i}`] || '' });
        }
      }
    }

    // clear shimmer & ensure list empty before appending real items
    hideShimmer();
    list.innerHTML = '';

    if (!items || items.length === 0) {
      empty.style.display = 'block';
      empty.innerText = 'No news loved yet? The favorites list is feeling lonely!';
      return;
    }

    // append with gradient cycling
    items.forEach((it, idx) => list.appendChild(createCard(it, idx)));
  } catch (e) {
    console.error('init fetch bookmark failed', e);
    hideShimmer();
    list.innerHTML = '';
    list.appendChild(createCard(FALLBACK, 0));
  }
})();
</script>
</body>
</html>